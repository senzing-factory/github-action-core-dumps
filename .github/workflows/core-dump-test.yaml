name: core dump test
on: [workflow_dispatch]
permissions: {}
jobs:
  core-dump-test-c:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Enable core dumps
        uses: senzing-factory/github-action-core-dumps@v1
        with:
          enable-core-dumps: "true"

      # Windows needs different commands
      - if: runner.os == 'Windows'
        name: Intentionally force a segfault (C) - Windows
        shell: cmd
        run: |
          cd "%GITHUB_WORKSPACE%\test"
          cl /Zi segfault.c /Fe:segfault.exe
          segfault.exe
        continue-on-error: true

      # Unix (Linux/macOS)
      - if: runner.os != 'Windows'
        name: Intentionally force a segfault (C) - Unix
        run: |
          ulimit -c unlimited
          cd "${GITHUB_WORKSPACE}/test"
          gcc -g segfault.c -o segfault
          ./segfault
        continue-on-error: true

      - if: always()
        name: Analyze core dumps
        uses: senzing-factory/github-action-core-dumps@v1
        with:
          analyze-core-dumps: "true"
          core-file-suffix: c-${{ matrix.os }}

  core-dump-test-python:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5

      - name: Enable core dumps
        uses: senzing-factory/github-action-core-dumps@v1
        with:
          enable-core-dumps: "true"

      # Windows Python crash
      - if: runner.os == 'Windows'
        name: Intentionally force a segfault (Python) - Windows
        shell: powershell
        run: python -c "import ctypes; ctypes.string_at(0)"
        continue-on-error: true

      # Unix Python crash
      - if: runner.os != 'Windows'
        name: Intentionally force a segfault (Python) - Unix
        run: |
          ulimit -c unlimited
          python3 -c "import os, signal; os.kill(os.getpid(), signal.SIGSEGV)"
        continue-on-error: true

      - if: always()
        name: Analyze core dumps
        uses: senzing-factory/github-action-core-dumps@v1
        with:
          analyze-core-dumps: "true"
          core-file-suffix: python-${{ matrix.os }}

  core-dump-test-go:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"

      - name: Enable core dumps
        uses: senzing-factory/github-action-core-dumps@v1
        with:
          enable-core-dumps: "true"

      # Windows Go crash
      - if: runner.os == 'Windows'
        name: Intentionally force a segfault (Go) - Windows
        shell: powershell
        run: |
          cd "$env:GITHUB_WORKSPACE\test"
          go build -gcflags='all=-N -l' -o segfault.exe segfault.go
          $env:GOTRACEBACK = "crash"
          .\segfault.exe
        continue-on-error: true

      # Unix Go crash
      - if: runner.os != 'Windows'
        name: Intentionally force a segfault (Go) - Unix
        run: |
          ulimit -c unlimited
          cd "${GITHUB_WORKSPACE}/test"
          go build -gcflags='all=-N -l' -o segfault segfault.go
          GOTRACEBACK=crash ./segfault
        continue-on-error: true

      - if: always()
        name: Analyze core dumps
        uses: senzing-factory/github-action-core-dumps@v1
        with:
          analyze-core-dumps: "true"
          core-file-suffix: go-${{ matrix.os }}
